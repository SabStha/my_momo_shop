<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Angular and Vue History API requests
    RewriteCond %{REQUEST_FILENAME} -d [OR]
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ ^$1 [N]

    RewriteCond %{REQUEST_URI} (\.\w+$) [NC]
    RewriteRule ^(.*)$ public/$1 

    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php

    # Deny access to .env files
    <Files ".env*">
        Order allow,deny
        Deny from all
    </Files>

    # Deny access to sensitive files
    <FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|git)$">
        Order allow,deny
        Deny from all
    </FilesMatch>

    # Security headers
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    </IfModule>

    # Disable server signature
    ServerSignature Off

    # Disable directory browsing
    Options -Indexes

    # Prevent access to storage and other sensitive directories
    RewriteRule ^storage/.* - [F,L]
    RewriteRule ^bootstrap/.* - [F,L]
    RewriteRule ^config/.* - [F,L]
    RewriteRule ^database/.* - [F,L]
    RewriteRule ^resources/.* - [F,L]
    RewriteRule ^routes/.* - [F,L]
    RewriteRule ^tests/.* - [F,L]
    RewriteRule ^vendor/.* - [F,L]
    RewriteRule ^\.git/.* - [F,L]
</IfModule>